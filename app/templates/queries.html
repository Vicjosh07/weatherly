{% extends "base.html" %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="m-0">Saved Weather Queries</h2>
  <div>
    <!-- Export all (csv) -->
    <a class="btn btn-success me-3" href="/export/queries?delim=," role="button">Export All CSV</a>
  </div>
</div>

  {% if queries %}
    <div class="list-group">
      {% for q in queries %}
        <div class="list-group-item mb-4">
          <b>{{ q.location }}</b> ({{ q.date_range or 'N/A' }})
          <pre style="background:#f8f9fa; padding:5px;">{{ q.result }}</pre>

          <!-- Map Container -->
          <div id="mapid-{{ q.id }}" style="height: 250px; border-radius: 10px;" class="mt-3"></div>

          <!-- Edit + Delete Buttons -->
          <div class="mt-3">
            <a href="/queries/{{ q.id }}/edit" class="btn btn-warning btn-sm">Edit</a>
            <a href="/queries/{{ q.id }}/delete" class="btn btn-danger btn-sm">Delete</a>
            <!-- Export single -->
            <a class="btn btn-success btn-sm" href="/export/query/{{ q.id }}?format=csv">Download CSV</a>
            

          </div>
        </div>

        <script>
  {% if q.parsed %}
    var data = {{ q.parsed | tojson }};
    if (data && data.lat && data.lon) {
      var map = L.map("mapid-{{ q.id }}").setView([data.lat, data.lon], 11);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
      L.marker([data.lat, data.lon]).addTo(map)
        .bindPopup(data.data.city || "{{ q.location }}")
        .openPopup();
    }
  {% else %}
    // no parsed data available (old row)
  {% endif %}
</script>
      {% endfor %}
    </div>
  {% else %}
    <p>No queries saved yet.</p>
  {% endif %}
  <a href="/" class="btn btn-secondary mt-3">Back</a>
{% endblock %}
