{% extends "base.html" %}
{% block content %}
  <h2>Edit Query</h2>

  {% if error %}
    <div class="alert alert-danger">{{ error }}</div>
  {% endif %}

  <!-- Map of current query location -->
  <div id="mapid-edit-{{ query.id }}" style="height: 250px; border-radius: 10px;" class="mb-3"></div>

  {# Robustly extract start/end date from query.date_range (accepts "YYYY-MM-DD to YYYY-MM-DD" or "YYYY-MM-DDtoYYYY-MM-DD" variants) #}
  {% set start_val = "" %}
  {% set end_val = "" %}
  {% if query.date_range and query.date_range != "current" %}
    {% if "to" in query.date_range %}
      {% set parts = query.date_range.split("to") %}
      {% if parts|length >= 2 %}
        {% set start_val = parts[0].strip() %}
        {% set end_val = parts[1].strip() %}
      {% endif %}
    {% endif %}
  {% endif %}

  <!-- Edit form: location + start/end date -->
  <form action="/queries/{{ query.id }}/update" method="post" class="mb-3">
    <div class="mb-3">
      <label class="form-label">Location</label>
      <input type="text" class="form-control" name="location" value="{{ query.location }}" required>
    </div>

    <div class="row g-2 align-items-center mb-2">
      <div class="col-auto">
        <label class="form-label">Start Date</label>
        <input
          type="date"
          name="start_date"
          id="start-date-{{ query.id }}"
          class="form-control"
          value="{{ start_val }}"
        >
      </div>

      <div class="col-auto">
        <label class="form-label">End Date</label>
        <input
          type="date"
          name="end_date"
          id="end-date-{{ query.id }}"
          class="form-control"
          value="{{ end_val }}"
        >
      </div>

      <div class="col-auto">
        <label class="form-label">Range (days)</label>
        <input type="text" id="range-display-{{ query.id }}" class="form-control" readonly>
      </div>
    </div>

    <div class="d-flex gap-2">
      <button type="submit" name="action" value="update" class="btn btn-success">Update</button>
      <button type="submit" name="action" value="view" class="btn btn-primary">View</button>
      <a href="/queries/" class="btn btn-secondary">Cancel</a>
    </div>
  </form>

  <script>
  {% if query.parsed %}
    var data = {{ query.parsed | tojson }};
    if (data && data.lat && data.lon) {
      var map = L.map("mapid-edit-{{ query.id }}").setView([data.lat, data.lon], 11);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: '&copy; <a href="https://www.openstreetmap.org/">OSM</a> contributors'
      }).addTo(map);
      L.marker([data.lat, data.lon]).addTo(map)
        .bindPopup(data.data.city || "{{ query.location }}")
        .openPopup();
    }
  {% else %}
    // no parsed data; optionally show a placeholder or keep map empty
  {% endif %}

  // date-range helper (keeps end.min >= start, computes inclusive days)
  (function() {
    const startEl = document.getElementById("start-date-{{ query.id }}");
    const endEl = document.getElementById("end-date-{{ query.id }}");
    const displayEl = document.getElementById("range-display-{{ query.id }}");

    function computeRange() {
      const s = startEl.value;
      const e = endEl.value;
      if (!s || !e) {
        displayEl.value = "";
        return;
      }
      const sd = new Date(s);
      const ed = new Date(e);
      if (ed < sd) {
        displayEl.value = "Invalid (end before start)";
        return;
      }
      // number of calendar days inclusive
      const diff = Math.floor((ed - sd) / (1000*60*60*24)) + 1;
      displayEl.value = diff + (diff === 1 ? " day" : " days");
      // enforce OpenWeatherMap 5-day max (<=5)
      if (diff > 5) {
        displayEl.value += " â€” max 5 days allowed";
      }
    }

    function syncMin() {
      if (startEl.value) {
        endEl.min = startEl.value;
      } else {
        endEl.removeAttribute("min");
      }
      computeRange();
    }

    // listeners
    startEl.addEventListener("change", syncMin);
    endEl.addEventListener("change", computeRange);

    // initialize on load
    syncMin();
  })();
  </script>

{% endblock %}
